(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const f={DEFAULT_RECORDING_FORMAT:"video/mp4",DEFAULT_RECORD_TIME_SLICE:1e4,INDEXED_DB:{DB_NAME:"recordingDB",STORES:{VIDEO_CHUNKS:"videoChunks"}}},R=f.INDEXED_DB.DB_NAME,a=f.INDEXED_DB.STORES;let c;async function M(){return new Promise((e,o)=>{const r=indexedDB.open(R,1);r.onerror=()=>{var n;console.error(`open idb error: ${(n=r.error)==null?void 0:n.message}`),o()},r.onsuccess=()=>{console.log("open idb success",r.result),c=r.result,e(c)},r.onupgradeneeded=n=>{var t;c=(t=n.target)==null?void 0:t.result,console.log("db upgraded",c),c.objectStoreNames.contains(a.VIDEO_CHUNKS)||c.createObjectStore(a.VIDEO_CHUNKS,{keyPath:"timestamp"})}})}function _(){return new Promise((e,o)=>{const t=c.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).clear();t.onerror=()=>{o(t.error)},t.onsuccess=()=>{e(t.result)}})}async function k(e){return new Promise((o,r)=>{const s=c.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).add({chunk:e,timestamp:Date.now()});s.onerror=()=>{r(s.error)},s.onsuccess=()=>{console.log("success save chunk:",s.result),o(s.result)}})}async function v(){return new Promise((e,o)=>{const t=c.transaction(a.VIDEO_CHUNKS,"readonly").objectStore(a.VIDEO_CHUNKS).openCursor(),s=[];t.onerror=()=>{o(t.error)},t.onsuccess=()=>{const i=t.result;i?(s.push(i==null?void 0:i.value.chunk),i==null||i.continue()):e(s)}})}const N=[{extension:".mp4",mime:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',codecs:"H.264 + AAC",note:"Best compatibility across all browsers"},{extension:".webm",mime:'video/webm; codecs="vp8, opus"',codecs:"VP8 + Opus",note:"Open format, supported in most modern browsers"},{extension:".webm",mime:'video/webm; codecs="vp9, opus"',codecs:"VP9 + Opus",note:"More efficient than VP8; supported in most modern browsers"},{extension:".ogv",mime:'video/ogg; codecs="theora, vorbis"',codecs:"Theora + Vorbis",note:"Open format, works in Firefox and Chrome"},{extension:".webm",mime:'video/webm; codecs="av1"',codecs:"AV1",note:"Next-gen codec, modern browsers only, limited hardware support"}];function I(e){const r=(e/1048576).toFixed(2)+"MB",n=(e/1024).toFixed(2)+"KB";return e>1048576?r:n}const p=document.getElementById("mirrorBtn"),w=document.getElementById("playback"),D=document.getElementById("preview"),y=document.getElementById("startBtn"),b=document.getElementById("stopBtn"),m=document.getElementById("videoChunks"),E=document.getElementById("videoSource"),l=document.getElementById("videoFormat"),S=document.getElementById("chunkEvery"),P=document.getElementById("resultLabel"),T=/iPad|iPhone|iPod/.test(navigator.userAgent),g=localStorage.getItem("deviceId"),U=N;let d=null,u=null,h=!1;window.addEventListener("load",async()=>{T&&alert("iOS detected. If you're experiencing issues, your browser may not fully support camera access (getUserMedia). Try using a different browser or device for the best experience."),j(),await M()&&(await $(),V(),x())});window.addEventListener("beforeunload",e=>{h&&(e.preventDefault(),e.returnValue="")});E.addEventListener("change",async e=>{const o=e.target.value;localStorage.setItem("deviceId",o),await A(o)});p.addEventListener("click",H);y.addEventListener("click",K);b.addEventListener("click",C);async function V(){try{const e={video:g?{deviceId:{exact:g}}:!0,audio:!0},o=await navigator.mediaDevices.getUserMedia(e);B(o),z(await navigator.mediaDevices.enumerateDevices())}catch(e){console.error("Permission denied or error:",e)}}async function x(){const e=await v();e.length&&(L(e),O(e))}async function A(e){try{const o={video:{deviceId:{exact:e}},audio:!0};F();const r=await navigator.mediaDevices.getUserMedia(o);B(r)}catch(o){console.error("Error switching camera:",o)}}function F(){u&&(u.getTracks().forEach(e=>e.stop()),u=null,C())}function B(e){u=e,D.srcObject=e}function L(e){const o=new Blob(e,{type:l.value}),r=URL.createObjectURL(o);q(o),w.src=r,w.style.display="block"}function H(){const e=p.classList.toggle("mirrored");D.style.transform=e?"scaleX(-1)":"scaleX(1)",p.innerHTML=e?"Unmirror":"Mirror",p.dataset.mirrored=String(e)}async function K(){if(!u)return;h=!0;const e=MediaRecorder.isTypeSupported(l.value)?l.value:"";d=new MediaRecorder(u,{mimeType:e});const o=[];(await v()).length&&await _(),d.addEventListener("dataavailable",async n=>{n.data.size>0&&(o.push(n.data),await k(n.data))}),d.addEventListener("stop",async()=>{const n=await v();O(n);const t=n!=null&&n.length?n:o;L(t)}),d.start(Number(S.value)),y.disabled=!0,b.disabled=!1}function C(){d&&d.state!=="inactive"&&d.stop(),y.disabled=!1,b.disabled=!0,h=!1}async function O(e){m&&m.querySelector("li")!==null&&(m.innerHTML=""),e.forEach((r,n)=>{const t=document.createElement("li");t.textContent=`Blob ${n+1}: { size: ${I(r.size)}, type: '${r.type}' }`,m.append(t)})}function z(e){const o=e.filter(r=>r.kind==="videoinput");E.innerHTML="",o.forEach((r,n)=>{const t=document.createElement("option");t.value=r.deviceId,t.text=r.label||`Camera ${n+1}`,t.selected=g===r.deviceId||n===0,E.appendChild(t)})}function $(){return new Promise(e=>{U.forEach((o,r)=>{const n=document.createElement("option");n.value=o.mime,n.text=`${o.extension}, ${o.codecs} (${o.note})`,n.selected=f.DEFAULT_RECORDING_FORMAT===o.mime||r===0,l.appendChild(n),e(l.value)})})}function j(){S.value=String(f.DEFAULT_RECORD_TIME_SLICE)}function q(e){P.innerHTML=`Result (${I(e.size)}):`}
