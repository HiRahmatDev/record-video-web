(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const d={VIDEO_TYPE:"video/webm",RECORD_TIME_SLICE_MS:1e3,INDEXED_DB:{DB_NAME:"recordingDB",STORES:{VIDEO_CHUNKS:"videoChunks"}}},w=d.INDEXED_DB.DB_NAME,a=d.INDEXED_DB.STORES;let i;async function O(){return new Promise((e,n)=>{const r=indexedDB.open(w,1);r.onerror=()=>{var o;console.error(`open idb error: ${(o=r.error)==null?void 0:o.message}`),n()},r.onsuccess=()=>{console.log("open idb success",r.result),i=r.result,e(i)},r.onupgradeneeded=o=>{var t;i=(t=o.target)==null?void 0:t.result,console.log("db upgraded",i),i.objectStoreNames.contains(a.VIDEO_CHUNKS)||i.createObjectStore(a.VIDEO_CHUNKS,{keyPath:"timestamp"})}})}function C(){return new Promise((e,n)=>{const t=i.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).clear();t.onerror=()=>{n(t.error)},t.onsuccess=()=>{e(t.result)}})}async function L(e){return new Promise((n,r)=>{const s=i.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).add({chunk:e,timestamp:Date.now()});s.onerror=()=>{r(s.error)},s.onsuccess=()=>{console.log("success save chunk:",s.result),n(s.result)}})}async function E(){return new Promise((e,n)=>{const t=i.transaction(a.VIDEO_CHUNKS,"readonly").objectStore(a.VIDEO_CHUNKS).openCursor(),s=[];t.onerror=()=>{n(t.error)},t.onsuccess=()=>{const c=t.result;c?(s.push(c==null?void 0:c.value.chunk),c==null||c.continue()):e(s)}})}const m=document.getElementById("mirrorBtn"),p=document.getElementById("playback"),h=document.getElementById("preview"),v=document.getElementById("startBtn"),D=document.getElementById("stopBtn"),f=document.getElementById("videoChunks"),y=document.getElementById("videoSource"),g=localStorage.getItem("deviceId");let l=null,u=null,I=!1;window.addEventListener("load",async()=>{await O()&&(_(),B())});window.addEventListener("beforeunload",e=>{I&&(e.preventDefault(),e.returnValue="")});y.addEventListener("change",async e=>{const n=e.target.value;localStorage.setItem("deviceId",n),await R(n)});m.addEventListener("click",N);v.addEventListener("click",P);D.addEventListener("click",U);async function B(){try{const e={video:g?{deviceId:{exact:g}}:!0,audio:!0},n=await navigator.mediaDevices.getUserMedia(e);b(n),V(await navigator.mediaDevices.enumerateDevices())}catch(e){console.error("Permission denied or error:",e)}}async function _(){const e=await E();e.length&&(M(e),S(e))}async function R(e){try{const n={video:{deviceId:{exact:e}},audio:!0};k();const r=await navigator.mediaDevices.getUserMedia(n);b(r)}catch(n){console.error("Error switching camera:",n)}}function k(){u&&(u.getTracks().forEach(e=>e.stop()),u=null)}function b(e){u=e,h.srcObject=e}function M(e){const n=new Blob(e,{type:d.VIDEO_TYPE}),r=URL.createObjectURL(n);p.src=r,p.style.display="block"}function N(){const e=m.classList.toggle("mirrored");h.style.transform=e?"scaleX(-1)":"scaleX(1)",m.innerHTML=e?"Unmirror":"Mirror",m.dataset.mirrored=String(e)}async function P(){if(!u)return;I=!0;const e=MediaRecorder.isTypeSupported(d.VIDEO_TYPE)?d.VIDEO_TYPE:"";l=new MediaRecorder(u,{mimeType:e});const n=[];(await E()).length&&await C(),l.addEventListener("dataavailable",async o=>{o.data.size>0&&(n.push(o.data),await L(o.data))}),l.addEventListener("stop",async()=>{const o=await E();S(o);const t=o!=null&&o.length?o:n,s=new Blob(t,{type:d.VIDEO_TYPE}),c=URL.createObjectURL(s);p.src=c,p.style.display="block"}),l.start(d.RECORD_TIME_SLICE_MS),v.disabled=!0,D.disabled=!1}function U(){l&&l.state!=="inactive"&&l.stop(),v.disabled=!1,D.disabled=!0,I=!1}async function S(e){f&&f.querySelector("li")!==null&&(f.innerHTML=""),e.forEach((r,o)=>{const t=document.createElement("li");t.textContent=`Blob ${o+1}: { size: ${(r.size/(1024*1024)).toFixed(2)}MB, type: '${r.type}' }`,f.append(t)})}function V(e){const n=e.filter(r=>r.kind==="videoinput");y.innerHTML="",n.forEach((r,o)=>{const t=document.createElement("option");t.value=r.deviceId,t.text=r.label||`Camera ${o+1}`,t.selected=g===r.deviceId||o===0,y.appendChild(t)})}
