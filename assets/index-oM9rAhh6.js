(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const v={DEFAULT_RECORDING_FORMAT:"video/mp4",DEFAULT_RECORD_TIME_SLICE:1e4,INDEXED_DB:{DB_NAME:"recordingDB",STORES:{VIDEO_CHUNKS:"videoChunks"}}},p=v.INDEXED_DB.DB_NAME,a=v.INDEXED_DB.STORES;let i;async function k(){return new Promise((e,o)=>{const r=indexedDB.open(p,1);r.onerror=()=>{var n;console.error(`open idb error: ${(n=r.error)==null?void 0:n.message}`),o()},r.onsuccess=()=>{console.log("open idb success",r.result),i=r.result,e(i)},r.onupgradeneeded=n=>{var t;i=(t=n.target)==null?void 0:t.result,console.log("db upgraded",i),i.objectStoreNames.contains(a.VIDEO_CHUNKS)||i.createObjectStore(a.VIDEO_CHUNKS,{keyPath:"timestamp"})}})}function M(){return new Promise((e,o)=>{const t=i.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).clear();t.onerror=()=>{o(t.error)},t.onsuccess=()=>{e(t.result)}})}async function _(e){return new Promise((o,r)=>{const s=i.transaction(a.VIDEO_CHUNKS,"readwrite").objectStore(a.VIDEO_CHUNKS).add({chunk:e,timestamp:Date.now()});s.onerror=()=>{r(s.error)},s.onsuccess=()=>{console.log("success save chunk:",s.result),o(s.result)}})}async function E(){return new Promise((e,o)=>{const t=i.transaction(a.VIDEO_CHUNKS,"readonly").objectStore(a.VIDEO_CHUNKS).openCursor(),s=[];t.onerror=()=>{o(t.error)},t.onsuccess=()=>{const c=t.result;c?(s.push(c==null?void 0:c.value.chunk),c==null||c.continue()):e(s)}})}const N=()=>{const e=indexedDB.deleteDatabase(p);e.onsuccess=()=>{console.log(`Database "${p}" deleted successfully.`)},e.onerror=o=>{console.error(`Error deleting database "${p}":`,o)},e.onblocked=()=>{location.reload()}},P=[{extension:".mp4",mime:'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',codecs:"H.264 + AAC",note:"Best compatibility across all browsers"},{extension:".webm",mime:'video/webm; codecs="vp8, opus"',codecs:"VP8 + Opus",note:"Open format, supported in most modern browsers"},{extension:".webm",mime:'video/webm; codecs="vp9, opus"',codecs:"VP9 + Opus",note:"More efficient than VP8; supported in most modern browsers"},{extension:".ogv",mime:'video/ogg; codecs="theora, vorbis"',codecs:"Theora + Vorbis",note:"Open format, works in Firefox and Chrome"},{extension:".webm",mime:'video/webm; codecs="av1"',codecs:"AV1",note:"Next-gen codec, modern browsers only, limited hardware support"}];function I(e){const r=(e/1048576).toFixed(2)+"MB",n=(e/1024).toFixed(2)+"KB";return e>1048576?r:n}const f=document.getElementById("mirrorBtn"),w=document.getElementById("playback"),B=document.getElementById("preview"),b=document.getElementById("startBtn"),h=document.getElementById("stopBtn"),m=document.getElementById("videoChunks"),g=document.getElementById("videoSource"),u=document.getElementById("videoFormat"),S=document.getElementById("chunkEvery"),T=document.getElementById("resultLabel"),U=document.getElementById("clearDbBtn"),V=/iPad|iPhone|iPod/.test(navigator.userAgent),y=localStorage.getItem("deviceId"),x=P;let d=null,l=null,D=!1;window.addEventListener("load",async()=>{V&&alert("iOS detected. If you're experiencing issues, your browser may not fully support camera access (getUserMedia). Try using a different browser or device for the best experience."),X(),await k()&&(await q(),A(),F())});window.addEventListener("beforeunload",e=>{D&&(e.preventDefault(),e.returnValue="")});g.addEventListener("change",async e=>{const o=e.target.value;localStorage.setItem("deviceId",o),await H(o)});f.addEventListener("click",$);b.addEventListener("click",z);h.addEventListener("click",O);U.addEventListener("click",N);async function A(){try{const e={video:y?{deviceId:{exact:y}}:!0,audio:!0},o=await navigator.mediaDevices.getUserMedia(e);L(o),j(await navigator.mediaDevices.enumerateDevices())}catch(e){console.error("Permission denied or error:",e)}}async function F(){const e=await E();e.length&&(C(e),R(e))}async function H(e){try{const o={video:{deviceId:{exact:e}},audio:!0};K();const r=await navigator.mediaDevices.getUserMedia(o);L(r)}catch(o){console.error("Error switching camera:",o)}}function K(){l&&(l.getTracks().forEach(e=>e.stop()),l=null,O())}function L(e){l=e,B.srcObject=e}function C(e){const o=new Blob(e,{type:u.value}),r=URL.createObjectURL(o);G(o),w.src=r,w.style.display="block"}function $(){const e=f.classList.toggle("mirrored");B.style.transform=e?"scaleX(-1)":"scaleX(1)",f.innerHTML=e?"Unmirror":"Mirror",f.dataset.mirrored=String(e)}async function z(){if(!l)return;D=!0;const e=MediaRecorder.isTypeSupported(u.value)?u.value:"";d=new MediaRecorder(l,{mimeType:e});const o=[];(await E()).length&&await M(),d.addEventListener("dataavailable",async n=>{n.data.size>0&&(o.push(n.data),await _(n.data))}),d.addEventListener("stop",async()=>{const n=await E();R(n);const t=n!=null&&n.length?n:o;C(t)}),d.start(Number(S.value)),b.disabled=!0,h.disabled=!1}function O(){d&&d.state!=="inactive"&&d.stop(),b.disabled=!1,h.disabled=!0,D=!1}async function R(e){m&&m.querySelector("li")!==null&&(m.innerHTML=""),e.forEach((r,n)=>{const t=document.createElement("li");t.textContent=`Blob ${n+1}: { size: ${I(r.size)}, type: '${r.type}' }`,m.append(t)})}function j(e){const o=e.filter(r=>r.kind==="videoinput");g.innerHTML="",o.forEach((r,n)=>{const t=document.createElement("option");t.value=r.deviceId,t.text=r.label||`Camera ${n+1}`,t.selected=y===r.deviceId||n===0,g.appendChild(t)})}function q(){return new Promise(e=>{x.forEach((o,r)=>{const n=document.createElement("option");n.value=o.mime,n.text=`${o.extension}, ${o.codecs} (${o.note})`,n.selected=v.DEFAULT_RECORDING_FORMAT===o.mime||r===0,u.appendChild(n),e(u.value)})})}function X(){S.value=String(v.DEFAULT_RECORD_TIME_SLICE)}function G(e){T.innerHTML=`Result (${I(e.size)}):`}
